<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Управляемый кубик</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
        }

        canvas {
            display: block;
        }
    </style>
</head>
<body>
    <canvas id="renderCanvas"></canvas>
    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    <script src="https://cdn.babylonjs.com/cannon.js"></script>
    <script>

        
        document.addEventListener("DOMContentLoaded", function () {
            const canvas = document.getElementById("renderCanvas");
            const engine = new BABYLON.Engine(canvas, true);

            const resizeCanvas = function () {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            };

            // Инициализация размеров холста
            resizeCanvas();

            // Обработка изменения размеров окна
            window.addEventListener("resize", function () {
                resizeCanvas();
                engine.resize();
            });

            const createScene = function () {
                const scene = new BABYLON.Scene(engine);
                scene.enablePhysics(); // Включаем физику для сцены

                // Создаем серую плоскость
                const ground = BABYLON.Mesh.CreateGround("ground", 2000, 2000, 1, scene, false);
                ground.position.y = -0.5; // Опустить плоскость на половину высоты кубика

                // Настройка физики для плоскости
                ground.physicsImpostor = new BABYLON.PhysicsImpostor(ground, BABYLON.PhysicsImpostor.BoxImpostor, { mass: 0, friction: 1 }, scene);


                // Создаем текстуру песка
                const sandTexture = new BABYLON.Texture("https://i.pinimg.com/originals/05/4f/99/054f997dd83de6e354560339c5b3c0de.jpg", scene);
                // Создаем материал с текстурой песка
                // Создаем материал с текстурой песка
                const sandMaterial = new BABYLON.StandardMaterial("sandMaterial", scene);
                sandMaterial.diffuseTexture = sandTexture;
                // Настраиваем материал для матового отражения
                sandMaterial.diffuseColor = new BABYLON.Color3(1, 1, 1); // Белый цвет
                sandMaterial.specularColor = new BABYLON.Color3(0, 0, 0); // Отсутствие бликов
                sandMaterial.ambientColor = new BABYLON.Color3(1, 1, 1); // Белый цвет для отражения окружающей среды
                // Назначаем материал плоскости
                ground.material = sandMaterial;


                // Создаем красный кубик выше плоскости
                const box = BABYLON.Mesh.CreateBox("box", 1, scene);
                box.position.y = 10; // Поднять кубик выше плоскости

                // Настройка физики для кубика
                box.physicsImpostor = new BABYLON.PhysicsImpostor(box, BABYLON.PhysicsImpostor.BoxImpostor, { mass: 1, friction: 5 }, scene);

                // Создаем камеру следа
                const camera = new BABYLON.FollowCamera("camera", new BABYLON.Vector3(0, 5, -10), scene);
                camera.lockedTarget = box; // Устанавливаем цель для камеры
                camera.radius = 10; // Расстояние до цели
                camera.heightOffset = 3; // Высота относительно цели
                camera.rotationOffset = 0; // Угол поворота
                camera.cameraAcceleration = 0.01; // Ускорение камеры
                camera.maxCameraSpeed = 1; // Максимальная скорость камеры

                // Управление камерой мышью
                camera.attachControl(canvas, true);

                // Добавляем направленный свет
                const light = new BABYLON.DirectionalLight("light", new BABYLON.Vector3(0, -1, -0.5), scene);

                // Настраиваем тени от света
                light.castShadow = true;

                let canControl = false; // Флаг для управления кубиком

                const inputMap = {};
                scene.actionManager = new BABYLON.ActionManager(scene);
                scene.actionManager.registerAction(
                    new BABYLON.ExecuteCodeAction(
                        BABYLON.ActionManager.OnKeyDownTrigger,
                        function (evt) {
                            if (canControl) {
                                inputMap[evt.sourceEvent.key] = evt.sourceEvent.type == "keydown";
                                if (evt.sourceEvent.key == " ") { // Проверяем, нажата ли клавиша "пробел"
                                    // Применяем импульс вверх кубику
                                    box.physicsImpostor.applyImpulse(new BABYLON.Vector3(0, 3, 0), box.getAbsolutePosition());
                                }
                            }
                        }
                    )
                );
                scene.actionManager.registerAction(
                    new BABYLON.ExecuteCodeAction(
                        BABYLON.ActionManager.OnKeyUpTrigger,
                        function (evt) {
                            if (canControl) {
                                inputMap[evt.sourceEvent.key] = evt.sourceEvent.type == "keydown";
                            }
                        }
                    )
                );

                scene.onBeforeRenderObservable.add(() => {
                    if (box.intersectsMesh(ground, false) && !canControl) {
                        canControl = true;
                        // Убираем кинематику у плоскости
                        ground.physicsImpostor.setLinearVelocity(new BABYLON.Vector3(0, 0, 0));
                    }

                    if (canControl) {
                        if (inputMap["w"]) {
                            box.physicsImpostor.applyImpulse(new BABYLON.Vector3(0, 0, 0.3), box.getAbsolutePosition());
                        }
                        if (inputMap["s"]) {
                            box.physicsImpostor.applyImpulse(new BABYLON.Vector3(0, 0, -0.3), box.getAbsolutePosition());
                        }
                        if (inputMap["a"]) {
                            box.physicsImpostor.applyImpulse(new BABYLON.Vector3(-0.3, 0, 0), box.getAbsolutePosition());
                        }
                        if (inputMap["d"]) {
                            box.physicsImpostor.applyImpulse(new BABYLON.Vector3(0.3, 0, 0), box.getAbsolutePosition());
                        }
                    }
                });

                return scene;
            };

            const scene = createScene();

            engine.runRenderLoop(function () {
                scene.render();
            });
        });


    </script>


</body>
</html>
