<!DOCTYPE html>
<html>
<head>
    <title>2D Online Game</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
        }

        #gameCanvas {
            width: 100%;
            height: 100vh;
            display: block;
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>
    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // Устанавливаем размер холста на основе размера окна браузера
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }

        // Вызываем функцию resizeCanvas при загрузке и изменении размера окна
        window.addEventListener('resize', resizeCanvas);
        window.addEventListener('load', resizeCanvas);

        const ws = new WebSocket('wss://intermediate-easy-ship.glitch.me');
        const players = new Map();
        const trails = new Map(); // Массив для следов

        // Текущая позиция игрока
        let currentPlayerX = canvas.width / 2;
        let currentPlayerY = canvas.height / 2;

        // Целевая позиция для движения кубика
        let targetX = currentPlayerX;
        let targetY = currentPlayerY;

        ws.onopen = () => {
            console.log('Connected to server');
        };

        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);

            if (data.type === 'playerInfo') {
                createOrUpdatePlayer(data);
            } else if (data.type === 'playerUpdate') {
                updatePlayerPosition(data);
            } else if (data.type === 'playerDisconnect') {
                removePlayer(data.id);
            }
        };

        function createOrUpdatePlayer(playerData) {
            if (!players.has(playerData.id)) {
                players.set(playerData.id, playerData);
            } else {
                players.set(playerData.id, { ...players.get(playerData.id), ...playerData });
            }

            drawPlayers();
        }

        function updatePlayerPosition(playerData) {
            createOrUpdatePlayer(playerData);
            // Добавляем след при обновлении позиции игрока
            trails.set(playerData.id, { x: playerData.x, y: playerData.y, alpha: 1.0 });
        }

        function removePlayer(playerId) {
            players.delete(playerId);
            trails.delete(playerId);
            drawPlayers();
        }

        function drawPlayers() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            for (const [playerId, player] of players) {
                ctx.fillStyle = player.color || 'blue';
                const x = player.x - (canvas.width / 2); // Центрируем игрока относительно экрана
                const y = player.y - (canvas.height / 2); // Центрируем игрока относительно экрана
                ctx.fillRect(x, y, 20, 20);
            }
        }

        // Обработчик клика для установки целевой позиции
        canvas.addEventListener('click', (event) => {
            const rect = canvas.getBoundingClientRect();
            targetX = event.clientX - rect.left + canvas.width / 2; // Центрируем цель относительно экрана
            targetY = event.clientY - rect.top + canvas.height / 2; // Центрируем цель относительно экрана
        });

        // Анимация движения кубика к целевой позиции
        function moveCurrentPlayer() {
            const dx = targetX - currentPlayerX;
            const dy = targetY - currentPlayerY;
            const speed = 2; // Скорость движения

            if (Math.abs(dx) > speed || Math.abs(dy) > speed) {
                const angle = Math.atan2(dy, dx);
                currentPlayerX += Math.cos(angle) * speed;
                currentPlayerY += Math.sin(angle) * speed;
            } else {
                currentPlayerX = targetX;
                currentPlayerY = targetY;
            }

            // Отправляем информацию о позиции на сервер
            if (ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'playerPosition', x: currentPlayerX, y: currentPlayerY }));
            }

            // Рисуем текущего игрока
            ctx.fillStyle = 'red';
            const x = currentPlayerX - (canvas.width / 2); // Центрируем игрока относительно экрана
            const y = currentPlayerY - (canvas.height / 2); // Центрируем игрока относительно экрана
            ctx.fillRect(x, y, 20, 20);

            // Рисуем и обновляем следы
            for (const [playerId, trail] of trails) {
                ctx.fillStyle = 'rgba(255, 0, 0, ' + trail.alpha + ')';
                const trailX = trail.x - (canvas.width / 2); // Центрируем след относительно экрана
                const trailY = trail.y - (canvas.height / 2); // Центрируем след относительно экрана
                ctx.fillRect(trailX, trailY, 20, 20);
                trail.alpha -= 0.01; // Уменьшаем прозрачность следа
                if (trail.alpha <= 0) {
                    trails.delete(playerId); // Удаляем след, когда прозрачность достигает 0
                }
            }

            requestAnimationFrame(moveCurrentPlayer);
        }
        moveCurrentPlayer();
    </script>
</body>
</html>
