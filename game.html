<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Управляемый кубик</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
        }

        canvas {
            display: block;
        }
    </style>
</head>
<body>
    <canvas id="renderCanvas"></canvas>
    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    <script src="https://cdn.babylonjs.com/cannon.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const canvas = document.getElementById("renderCanvas");
            const engine = new BABYLON.Engine(canvas, true);

            const resizeCanvas = function () {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            };

            resizeCanvas();

            window.addEventListener("resize", function () {
                resizeCanvas();
                engine.resize();
            });

            const createScene = function () {
                const scene = new BABYLON.Scene(engine);
                scene.enablePhysics();

                const ground = BABYLON.Mesh.CreateGround("ground", 20000, 20000, 1, scene, false);
                ground.position.y = -0.5;
                ground.physicsImpostor = new BABYLON.PhysicsImpostor(ground, BABYLON.PhysicsImpostor.BoxImpostor, { mass: 0, friction: 1 }, scene);

                const sandTexture = new BABYLON.Texture("https://i.pinimg.com/originals/05/4f/99/054f997dd83de6e354560339c5b3c0de.jpg", scene);
                const sandMaterial = new BABYLON.StandardMaterial("sandMaterial", scene);
                sandMaterial.diffuseTexture = sandTexture;
                sandMaterial.diffuseColor = new BABYLON.Color3(1, 1, 1);
                sandMaterial.specularColor = new BABYLON.Color3(0, 0, 0);
                sandMaterial.ambientColor = new BABYLON.Color3(1, 1, 1);
                ground.material = sandMaterial;

                const box = BABYLON.Mesh.CreateBox("box", 1, scene);
                box.position.y = 10;
                box.physicsImpostor = new BABYLON.PhysicsImpostor(box, BABYLON.PhysicsImpostor.BoxImpostor, { mass: 1, friction: 5 }, scene);

                const camera = new BABYLON.ArcRotateCamera("camera", 0, 0, 0, box.position, scene);
                camera.lowerRadiusLimit = 5;
                camera.upperRadiusLimit = 20;
                camera.attachControl(canvas, true);

                scene.registerBeforeRender(function() {
                    camera.target = box.position.clone();
                });

                const light = new BABYLON.DirectionalLight("light", new BABYLON.Vector3(0, -1, -0.5), scene);
                light.castShadow = true;

                let canControl = false;
                const inputMap = {};
                scene.actionManager = new BABYLON.ActionManager(scene);
                scene.actionManager.registerAction(
                    new BABYLON.ExecuteCodeAction(
                        BABYLON.ActionManager.OnKeyDownTrigger,
                        function (evt) {
                            if (canControl) {
                                inputMap[evt.sourceEvent.key] = evt.sourceEvent.type == "keydown";
                                if (evt.sourceEvent.key == " ") {
                                    box.physicsImpostor.applyImpulse(new BABYLON.Vector3(0, 3, 0), box.getAbsolutePosition());
                                }
                            }
                        }
                    )
                );
                scene.actionManager.registerAction(
                    new BABYLON.ExecuteCodeAction(
                        BABYLON.ActionManager.OnKeyUpTrigger,
                        function (evt) {
                            if (canControl) {
                                inputMap[evt.sourceEvent.key] = evt.sourceEvent.type == "keydown";
                            }
                        }
                    )
                );

                const zombies = [];

                setInterval(function () {
                    const zombie = createZombie(scene, box);
                    zombies.push(zombie);
                }, 10000);

                scene.onBeforeRenderObservable.add(() => {
                    if (box.intersectsMesh(ground, false) && !canControl) {
                        canControl = true;
                        ground.physicsImpostor.setLinearVelocity(new BABYLON.Vector3(0, 0, 0));
                    }

                    if (canControl) {
                        if (inputMap["w"]) {
                            box.physicsImpostor.applyImpulse(new BABYLON.Vector3(0, 0, 0.3), box.getAbsolutePosition());
                        }
                        if (inputMap["s"]) {
                            box.physicsImpostor.applyImpulse(new BABYLON.Vector3(0, 0, -0.3), box.getAbsolutePosition());
                        }
                        if (inputMap["a"]) {
                            box.physicsImpostor.applyImpulse(new BABYLON.Vector3(-0.3, 0, 0), box.getAbsolutePosition());
                        }
                        if (inputMap["d"]) {
                            box.physicsImpostor.applyImpulse(new BABYLON.Vector3(0.3, 0, 0), box.getAbsolutePosition());
                        }
                    }

                    // Обновляем позицию каждого зомби
                    for (const zombie of zombies) {
                        const direction = box.position.subtract(zombie.position);
                        direction.normalize();
                        const force = direction.scale(50); // Настройте силу движения зомби
                        zombie.physicsImpostor.applyForce(force, zombie.getAbsolutePosition());
                    }
                });

                return scene;
            };

            const scene = createScene();

            engine.runRenderLoop(function () {
                scene.render();
            });
        });

        function createZombie(scene, player) {
            const zombie = BABYLON.Mesh.CreateBox("zombie", 1, scene);
            zombie.position = new BABYLON.Vector3(player.position.x + Math.random() * 10 - 5, 1, player.position.z + Math.random() * 10 - 5);
            zombie.physicsImpostor = new BABYLON.PhysicsImpostor(zombie, BABYLON.PhysicsImpostor.BoxImpostor, { mass: 1, friction: 5 }, scene);

            const zombieMaterial = new BABYLON.StandardMaterial("zombieMaterial", scene);
            zombieMaterial.diffuseColor = new BABYLON.Color3(0, 1, 0);
            zombie.material = zombieMaterial;

            return zombie;
        }
    </script>
</body>
</html>
