<!DOCTYPE html>
<html>
<head>
    <title>2D Online Game</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
        }

        #gameCanvas {
            width: 100%;
            height: 100vh;
            display: block;
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>
    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // Устанавливаем размер холста на основе размера окна браузера
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }

        // Вызываем функцию resizeCanvas при загрузке и изменении размера окна
        window.addEventListener('resize', resizeCanvas);
        window.addEventListener('load', resizeCanvas);

        const ws = new WebSocket('wss://intermediate-easy-ship.glitch.me');
        const players = new Map();
        const trails = new Map(); // Мап для следов

        // Текущая позиция игрока
        let currentPlayerX = canvas.width / 2;
        let currentPlayerY = canvas.height / 2;

        // Целевая позиция для движения кубика
        let targetX = currentPlayerX;
        let targetY = currentPlayerY;

        // Определение переменных для камеры
        let cameraX = canvas.width / 2;
        let cameraY = canvas.height / 2;

        ws.onopen = () => {
            console.log('Connected to server');
        };

        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);

            if (data.type === 'playerInfo') {
                createOrUpdatePlayer(data);
            } else if (data.type === 'playerUpdate') {
                updatePlayerPosition(data);
            } else if (data.type === 'playerDisconnect') {
                removePlayer(data.id);
            }
        };

        function createOrUpdatePlayer(playerData) {
            if (!players.has(playerData.id)) {
                players.set(playerData.id, playerData);
            } else {
                players.set(playerData.id, { ...players.get(playerData.id), ...playerData });
            }

            drawPlayers();
        }

        // В функции updatePlayerPosition измените добавление следа следующим образом:
function updatePlayerPosition(playerData) {
    createOrUpdatePlayer(playerData);
    const player = players.get(playerData.id);

    // Получите след текущего игрока
    const playerTrail = trails.get(playerData.id);

    // Проверьте, существует ли массив следов для этого игрока
    if (!playerTrail) {
        trails.set(playerData.id, []);
    }

    // Получите обновленный след текущего игрока
    const updatedTrail = trails.get(playerData.id);

    // Добавьте след к текущему игроку
    updatedTrail.push({ x: playerData.x, y: playerData.y, alpha: 1.0 });
}



        function removePlayer(playerId) {
            players.delete(playerId);
            trails.delete(playerId);
            drawPlayers();
        }

        function drawPlayers() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // Пересчитываем положение камеры
    cameraX = currentPlayerX - canvas.width / 2;
    cameraY = currentPlayerY - canvas.height / 2;

    // Отобразим след игрока
    trails.forEach((playerTrails, playerId) => {
        ctx.strokeStyle = 'red'; // Цвет следа
        ctx.lineWidth = 2; // Ширина линии следа

        playerTrails.forEach((trail, index) => {
            const trailX = trail.x - cameraX;
            const trailY = trail.y - cameraY; // Учитываем смещение камеры

            if (index === 0) {
                ctx.beginPath();
                ctx.moveTo(trailX, trailY);
            } else {
                ctx.lineTo(trailX, trailY);
            }
        });

        ctx.stroke();
    });

    // Рисуем всех игроков
    players.forEach((player, playerId) => {
        ctx.fillStyle = player.color || 'blue';
        const x = player.x - cameraX; // Учитываем смещение камеры
        const y = player.y - cameraY; // Учитываем смещение камеры
        ctx.fillRect(x, y, 20, 20);
    });
}


        // Обработчик клика для установки целевой позиции
        canvas.addEventListener('click', (event) => {
            const rect = canvas.getBoundingClientRect();
            targetX = event.clientX - rect.left + cameraX; // Учитываем смещение камеры
            targetY = event.clientY - rect.top + cameraY; // Учитываем смещение камеры
        });

        // Анимация движения кубика к целевой позиции
        function moveCurrentPlayer() {
            const dx = targetX - currentPlayerX;
            const dy = targetY - currentPlayerY;
            const speed = 2; // Скорость движения

            if (Math.abs(dx) > speed || Math.abs(dy) > speed) {
                const angle = Math.atan2(dy, dx);
                currentPlayerX += Math.cos(angle) * speed;
                currentPlayerY += Math.sin(angle) * speed;
            } else {
                currentPlayerX = targetX;
                currentPlayerY = targetY;
            }

            // Отправляем информацию о позиции на сервер
            if (ws.readyState === WebSocket.OPEN) {
                // Отправляем как объект, включая данные о следе
                ws.send(JSON.stringify({
                    type: 'playerPosition',
                    x: currentPlayerX,
                    y: currentPlayerY,
                    trail: { x: currentPlayerX, y: currentPlayerY, alpha: 1.0 }, // Добавляем информацию о следе
                }));
            }

            // Рисуем текущего игрока и его след змейки
            drawPlayers();

            requestAnimationFrame(moveCurrentPlayer);
        }

        moveCurrentPlayer();
    </script>
</body>
</html>
